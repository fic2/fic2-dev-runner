{
  "Resources" : {
    "PanamaxEc2Instance" : {
      "Type" : "AWS::EC2::Instance",
      "Properties" : {
        "Tags" : [ {"Key" : "Name", "Value" : "FIC2Lab Panamax"} ],
        "SecurityGroups" : [ { "Ref" : "PanamaxSecurityGroup" } ],
        "ImageId" : "ami-cd8ef9ba",
        "InstanceType": "m3.medium",
        "UserData": "I2Nsb3VkLWNvbmZpZwoKd3JpdGVfZmlsZXM6CiAgLSBwYXRoOiAnL2V0Yy9zeXN0ZW1kL2pvdXJuYWxkLmNvbmYuZC81MC1saW1pdC1qb3VybmFsLXNpemUuY29uZicKICAgIGNvbnRlbnQ6IHwKICAgICAgW0pvdXJuYWxdCiAgICAgIENvbXByZXNzPXllcwogICAgICBTeXN0ZW1NYXhVc2U9NTAwTQogICAgICBTeXN0ZW1NYXhGaWxlU2l6ZT0xME0KICAtIHBhdGg6ICcvZXRjL3N5c3RlbWQvcmVzb2x2ZWQuY29uZi5kLzEwLWZpeF9kbnMuY29uZicKICAgIGNvbnRlbnQ6IHwKICAgICAgW1Jlc29sdmVdCiAgICAgIEROUz04LjguOC44CiAgICAgIEZhbGxiYWNrRE5TPTguOC40LjQKICAtIHBhdGg6ICcvaG9tZS9jb3JlL2h1Yi5jb25mJwogICAgY29udGVudDogfAogICAgICB1cHN0cmVhbSB1cF9wYW5hbWF4X2FwaSB7CiAgICAgICAgc2VydmVyIFBNWF9BUEk6MzAwMDsKICAgICAgfQogICAgICB1cHN0cmVhbSB1cF9wYW5hbWF4X3VpIHsKICAgICAgICBzZXJ2ZXIgUE1YX1VJOjMwMDA7CiAgICAgIH0KCiAgICAgIHNlcnZlciB7CiAgICAgICAgcmV3cml0ZV9sb2cgb247CiAgICAgICAgbGlzdGVuICAgICAgIDYwMDEgc3NsOwogICAgICAgIHNlcnZlcl9uYW1lICBsb2NhbGhvc3Q7CiAgICAgICAgZXJyb3JfcGFnZSA0OTcgIGh0dHBzOi8vJGhvc3Q6JHNlcnZlcl9wb3J0JHJlcXVlc3RfdXJpOwogICAgICAgIHNzbCBvbjsKICAgICAgICBzc2xfY2VydGlmaWNhdGUgICAgICAvZXRjL25naW54L2NlcnQvc2VydmVyLmNydDsKICAgICAgICBzc2xfY2VydGlmaWNhdGVfa2V5ICAvZXRjL25naW54L2NlcnQvc2VydmVyLmtleTsKICAgICAgICBzc2xfc2Vzc2lvbl9jYWNoZSBzaGFyZWQ6U1NMOjFtOwogICAgICAgIHNzbF9zZXNzaW9uX3RpbWVvdXQgIDVtOwogICAgICAgIHNzbF9jaXBoZXJzICBISUdIOiFhTlVMTDohTUQ1OwogICAgICAgIHNzbF9wcmVmZXJfc2VydmVyX2NpcGhlcnMgICBvbjsKICAgICAgICBsb2NhdGlvbiAvIHsKICAgICAgICAgIHByb3h5X3Bhc3MgaHR0cDovL3VwX3BhbmFtYXhfYXBpOwogICAgICAgICAgcHJveHlfc2V0X2hlYWRlciBIb3N0ICRob3N0OyAjIG5naW54IHB1YmxpYyBpcAogICAgICAgICAgcHJveHlfc2V0X2hlYWRlciBYLUZvcndhcmRlZC1Ib3N0ICRodHRwX2hvc3Q7ICMgc2FtZSBhcyB0aGUgcmVxdWVzdCBIVFRQX0hPU1QKICAgICAgICAgIHByb3h5X3NldF9oZWFkZXIgWC1Gb3J3YXJkZWQtRm9yICRwcm94eV9hZGRfeF9mb3J3YXJkZWRfZm9yOyAjIGJyb3dzZXIgaXAKICAgICAgICAgIHByb3h5X3NldF9oZWFkZXIgWC1Gb3J3YXJkZWQtUHJvdG8gJHNjaGVtZTsKICAgICAgICAgIHByb3h5X3NldF9oZWFkZXIgWC1SZWFsLUlQICRyZW1vdGVfYWRkcjsKICAgICAgICAgICMgYWRkX2hlYWRlciAiQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luIiAiKiI7CiAgICAgICAgICAjIGFkZF9oZWFkZXIgIkFjY2Vzcy1Db250cm9sLUFsbG93LU1ldGhvZHMiICIqIjsKICAgICAgICB9CiAgICAgIH0KICAgICAgc2VydmVyIHsKICAgICAgICByZXdyaXRlX2xvZyBvbjsKICAgICAgICBsaXN0ZW4gICAgICAgNjAwMiBzc2w7CiAgICAgICAgc2VydmVyX25hbWUgIGxvY2FsaG9zdDsKICAgICAgICBlcnJvcl9wYWdlIDQ5NyAgaHR0cHM6Ly8kaG9zdDokc2VydmVyX3BvcnQkcmVxdWVzdF91cmk7CiAgICAgICAgc3NsIG9uOwogICAgICAgIHNzbF9jZXJ0aWZpY2F0ZSAgICAgIC9ldGMvbmdpbngvY2VydC9zZXJ2ZXIuY3J0OwogICAgICAgIHNzbF9jZXJ0aWZpY2F0ZV9rZXkgIC9ldGMvbmdpbngvY2VydC9zZXJ2ZXIua2V5OwogICAgICAgIHNzbF9zZXNzaW9uX2NhY2hlIHNoYXJlZDpTU0w6MW07CiAgICAgICAgc3NsX3Nlc3Npb25fdGltZW91dCAgNW07CiAgICAgICAgc3NsX2NpcGhlcnMgIEhJR0g6IWFOVUxMOiFNRDU7CiAgICAgICAgc3NsX3ByZWZlcl9zZXJ2ZXJfY2lwaGVycyAgIG9uOwogICAgICAgIGxvY2F0aW9uIC8gewogICAgICAgICAgcHJveHlfcGFzcyBodHRwOi8vdXBfcGFuYW1heF91aTsKICAgICAgICAgIHByb3h5X3NldF9oZWFkZXIgSG9zdCAkaG9zdDsgIyBuZ2lueCBwdWJsaWMgaXAKICAgICAgICAgIHByb3h5X3NldF9oZWFkZXIgWC1Gb3J3YXJkZWQtSG9zdCAkaHR0cF9ob3N0OyAjIHNhbWUgYXMgdGhlIHJlcXVlc3QgSFRUUF9IT1NUCiAgICAgICAgICBwcm94eV9zZXRfaGVhZGVyIFgtRm9yd2FyZGVkLUZvciAkcHJveHlfYWRkX3hfZm9yd2FyZGVkX2ZvcjsgIyBicm93c2VyIGlwCiAgICAgICAgICBwcm94eV9zZXRfaGVhZGVyIFgtRm9yd2FyZGVkLVByb3RvICRzY2hlbWU7CiAgICAgICAgICBwcm94eV9zZXRfaGVhZGVyIFgtUmVhbC1JUCAkcmVtb3RlX2FkZHI7CiAgICAgICAgICAjIGFkZF9oZWFkZXIgIkFjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbiIgIioiOwogICAgICAgICAgIyBhZGRfaGVhZGVyICJBY2Nlc3MtQ29udHJvbC1BbGxvdy1NZXRob2RzIiAiKiI7CiAgICAgICAgfQogICAgICB9Cgpjb3Jlb3M6CiAgdXBkYXRlOgogICAgcmVib290LXN0cmF0ZWd5OiAnb2ZmJwogIHVuaXRzOgogICAgLSBuYW1lOiAnc3lzdGVtZC1qb3VybmFsZC5zZXJ2aWNlJwogICAgICBjb21tYW5kOiAncmVsb2FkLW9yLXJlc3RhcnQnCiAgICAtIG5hbWU6ICdkb2NrZXIuc2VydmljZScKICAgICAgZHJvcC1pbnM6CiAgICAgICAgLSBuYW1lOiAnNTAtaW5zZWN1cmUtcmVnaXN0cnkuY29uZicKICAgICAgICAgIGNvbnRlbnQ6IHwKICAgICAgICAgICAgW1NlcnZpY2VdCiAgICAgICAgICAgIEVudmlyb25tZW50PSdET0NLRVJfT1BUUz0tLWxvZy1sZXZlbD0iZGVidWciIC0tcmVnaXN0cnktbWlycm9yPSJodHRwOi8vMTk1LjIyMC4yMjQuNjo4MDgwIiAtLWluc2VjdXJlLXJlZ2lzdHJ5PSIwLjAuMC4wLzAiJwogICAgLSBuYW1lOiAnc3lzdGVtZC1qb3VybmFsLWdhdGV3YXlkLnNlcnZpY2UnCiAgICAgIGNvbW1hbmQ6ICdzdGFydCcKICAgIC0gbmFtZTogJ2ZsZWV0LnNlcnZpY2UnCiAgICAgIGNvbW1hbmQ6ICdzdGFydCcKICAgIC0gbmFtZTogJ3BhbmFtYXgtbWV0cmljcy5zZXJ2aWNlJwogICAgICBjb21tYW5kOiAnc3RhcnQnCiAgICAgIGNvbnRlbnQ6IHwKICAgICAgICBbVW5pdF0KICAgICAgICBEZXNjcmlwdGlvbj1QYW5hbWF4IE1ldHJpY3MKICAgICAgICBBZnRlcj1kb2NrZXIuc2VydmljZQogICAgICAgIFJlcXVpcmVzPWRvY2tlci5zZXJ2aWNlCiAgICAgICAgW1NlcnZpY2VdCiAgICAgICAgRXhlY1N0YXJ0UHJlPS0vdXNyL2Jpbi9kb2NrZXIga2lsbCBQTVhfQ0FEVklTT1IKICAgICAgICBFeGVjU3RhcnRQcmU9LS91c3IvYmluL2RvY2tlciBybSAtZiBQTVhfQ0FEVklTT1IKICAgICAgICBFeGVjU3RhcnQ9L3Vzci9iaW4vZG9ja2VyIHJ1biAtLW5hbWU9UE1YX0NBRFZJU09SIC0tcm09dHJ1ZSAtLXZvbHVtZT0vdmFyL3J1bjovdmFyL3J1bjpydyAtLXZvbHVtZT0vc3lzOi9zeXM6cm8gLS12b2x1bWU9L3Zhci9saWIvZG9ja2VyLzovdmFyL2xpYi9kb2NrZXI6cm8gLS1wdWJsaXNoPTMwMDI6ODA4MCBnb29nbGUvY2Fkdmlzb3I6bGF0ZXN0IC1sb2dfZGlyIC8gLS1nbG9iYWxfaG91c2VrZWVwaW5nX2ludGVydmFsPTMwcyAtLWhvdXNla2VlcGluZ19pbnRlcnZhbD0xN3MKICAgICAgICBFeGVjU3RvcD0vdXNyL2Jpbi9kb2NrZXIgc3RvcCBQTVhfQ0FEVklTT1IKICAgICAgICBSZXN0YXJ0PWFsd2F5cwogICAgICAgIFtJbnN0YWxsXQogICAgICAgIFdhbnRlZEJ5PW11bHRpLXVzZXIudGFyZ2V0CiAgICAtIG5hbWU6ICdwYW5hbWF4LWFwaS5zZXJ2aWNlJwogICAgICBjb21tYW5kOiAnc3RhcnQnCiAgICAgIGNvbnRlbnQ6IHwKICAgICAgICBbVW5pdF0KICAgICAgICBEZXNjcmlwdGlvbj1QYW5hbWF4IEFQSQogICAgICAgIEFmdGVyPWRvY2tlci5zZXJ2aWNlCiAgICAgICAgUmVxdWlyZXM9ZG9ja2VyLnNlcnZpY2UKICAgICAgICBbU2VydmljZV0KICAgICAgICBFeGVjU3RhcnRQcmU9LS91c3IvYmluL2RvY2tlciBraWxsIFBNWF9BUEkKICAgICAgICBFeGVjU3RhcnRQcmU9LS91c3IvYmluL2RvY2tlciBybSBQTVhfQVBJCiAgICAgICAgRXhlY1N0YXJ0PS91c3IvYmluL2RvY2tlciBydW4gLS1uYW1lPVBNWF9BUEkgLS1ybT10cnVlIC12IC92YXIvcGFuYW1heC1kYXRhOi91c3Ivc3JjL2FwcC9kYi9tbnQgLXYgL3Zhci9ydW4vZG9ja2VyLnNvY2s6L3J1bi9kb2NrZXIuc29jazpydyAgLWUgSk9VUk5BTF9FTkRQT0lOVD1odHRwOi8vMTcyLjE3LjQyLjE6MTk1MzEgLXYgL3Zhci9ydW4vZmxlZXQuc29jazovdmFyL3J1bi9mbGVldC5zb2NrOnJ3IC10IC1wIDMwMDE6MzAwMCBmaWMyL3BhbmFtYXgtYXBpOmxhdGVzdAogICAgICAgIEV4ZWNTdG9wPS91c3IvYmluL2RvY2tlciBzdG9wIFBNWF9BUEkKICAgICAgICBSZXN0YXJ0PWFsd2F5cwogICAgICAgIFtJbnN0YWxsXQogICAgICAgIFdhbnRlZEJ5PW11bHRpLXVzZXIudGFyZ2V0CiAgICAtIG5hbWU6ICdwYW5hbWF4LXVpLnNlcnZpY2UnCiAgICAgIGNvbW1hbmQ6ICdzdGFydCcKICAgICAgY29udGVudDogfAogICAgICAgIFtVbml0XQogICAgICAgIERlc2NyaXB0aW9uPVBhbmFtYXggVUkKICAgICAgICBBZnRlcj1wYW5hbWF4LWFwaS5zZXJ2aWNlIHBhbmFtYXgtbWV0cmljcy5zZXJ2aWNlCiAgICAgICAgW1NlcnZpY2VdCiAgICAgICAgRXhlY1N0YXJ0UHJlPS0vdXNyL2Jpbi9kb2NrZXIga2lsbCBQTVhfVUkKICAgICAgICBFeGVjU3RhcnRQcmU9LS91c3IvYmluL2RvY2tlciBybSAtZiBQTVhfVUkKICAgICAgICBFeGVjU3RhcnQ9L3Vzci9iaW4vZG9ja2VyIHJ1biAtLW5hbWU9UE1YX1VJIC0tcm09dHJ1ZSAtdiAvdmFyL3J1bi9kb2NrZXIuc29jazovcnVuL2RvY2tlci5zb2NrOnJ3IC0tbGluaz1QTVhfQVBJOlBNWF9BUEkgLS1saW5rPVBNWF9DQURWSVNPUjpQTVhfQ0FEVklTT1IgLWUgMzAwMCAtcCAzMDAwOjMwMDAgIGZpYzIvcGFuYW1heC11aTpsYXRlc3QKICAgICAgICBFeGVjU3RvcD0vdXNyL2Jpbi9kb2NrZXIgc3RvcCBQTVhfVUkKICAgICAgICBSZXN0YXJ0PWFsd2F5cwogICAgICAgIFtJbnN0YWxsXQogICAgICAgIFdhbnRlZEJ5PW11bHRpLXVzZXIudGFyZ2V0CiAgICAtIG5hbWU6ICdwYW5hbWF4LWFwaS1uZ2lueC5zZXJ2aWNlJwogICAgICBjb21tYW5kOiAnc3RhcnQnCiAgICAgIGNvbnRlbnQ6IHwKICAgICAgICBbVW5pdF0KICAgICAgICBEZXNjcmlwdGlvbj1QYW5hbWF4IE5naW54IGZyb250ZW5kCiAgICAgICAgQWZ0ZXI9cGFuYW1heC1hcGkuc2VydmljZQogICAgICAgIFtTZXJ2aWNlXQogICAgICAgIEV4ZWNTdGFydFByZT0tL3Vzci9iaW4vZG9ja2VyIGtpbGwgUE1YX0FQSV9OR0lOWAogICAgICAgIEV4ZWNTdGFydFByZT0tL3Vzci9iaW4vZG9ja2VyIHJtIC1mIFBNWF9BUElfTkdJTlgKICAgICAgICBFeGVjU3RhcnQ9L3Vzci9iaW4vZG9ja2VyIHJ1biAtLW5hbWU9UE1YX0FQSV9OR0lOWCAtLXJtPXRydWUgLXQgLXYgL2Rldi91cmFuZG9tOi9kZXYvcmFuZG9tIC12IC9ob21lL2NvcmUvaHViLmNvbmY6L2V0Yy9uZ2lueC9zaXRlcy1lbmFibGVkL2h1Yi5jb25mIC0tbGluaz1QTVhfQVBJOlBNWF9BUEkgLS1saW5rPVBNWF9VSTpQTVhfVUkgLWUgNjAwMSAtcCA2MDAxOjYwMDEgLWUgNjAwMiAtcCA2MDAyOjYwMDIgY2dlb2Zmcm95L25naW54LWF1dG9fY2VydDpsYXRlc3QKICAgICAgICBFeGVjU3RvcD0vdXNyL2Jpbi9kb2NrZXIgc3RvcCBQTVhfQVBJX05HSU5YCiAgICAgICAgUmVzdGFydD1hbHdheXMKICAgICAgICBbSW5zdGFsbF0KICAgICAgICBXYW50ZWRCeT1tdWx0aS11c2VyLnRhcmdldA=="
      }
    },

    "PanamaxSecurityGroup" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "Tags" : [ {"Key" : "Name", "Value" : "FIC2Lab Panamax Security Group"} ],
        "GroupDescription" : "Enable SSH access via port 22",
        "SecurityGroupIngress" : [ 
        { "IpProtocol" : "tcp",
          "FromPort" : "22",
          "ToPort" : "22",
          "CidrIp" : "0.0.0.0/0" },
        { "IpProtocol" : "tcp",
          "FromPort" : "3000",
          "ToPort" : "3000",
          "CidrIp" : "0.0.0.0/0" },
        { "IpProtocol" : "tcp",
          "FromPort" : "3001",
          "ToPort" : "3001",
          "CidrIp" : "0.0.0.0/0" },
        { "IpProtocol" : "tcp",
          "FromPort" : "3002",
          "ToPort" : "3002",
          "CidrIp" : "0.0.0.0/0" },
        { "IpProtocol" : "tcp",
          "FromPort" : "49000",
          "ToPort" : "52000",
          "CidrIp" : "0.0.0.0/0" }
        ]
      }
    }
  },
  "Outputs": {
    "PanamaxURL": {
      "Value": {
        "Fn::Join": [
          "",
          [
            "http://",
            {
              "Fn::GetAtt": [
                "PanamaxEc2Instance",
                "PublicDnsName"
              ]
            },
            ":3000"
          ]
        ]
      },
      "Description" : "Panamax management console (you may need to wait a couple of minutes the first time)"
    }
  }
}
