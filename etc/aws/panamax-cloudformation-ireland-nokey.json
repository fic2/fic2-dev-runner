{
  "Resources" : {
    "PanamaxEc2Instance" : {
      "Type" : "AWS::EC2::Instance",
      "Properties" : {
        "Tags" : [ {"Key" : "Name", "Value" : "FIC2Lab Panamax"} ],
        "SecurityGroups" : [ { "Ref" : "PanamaxSecurityGroup" } ],
        "ImageId" : "ami-cd8ef9ba",
        "InstanceType": "m3.medium",
        "UserData": "I2Nsb3VkLWNvbmZpZwoKd3JpdGVfZmlsZXM6CiAgLSBwYXRoOiAnL2V0Yy9zeXN0ZW1kL2pvdXJuYWxkLmNvbmYuZC81MC1saW1pdC1qb3VybmFsLXNpemUuY29uZicKICAgIGNvbnRlbnQ6IHwKICAgICAgW0pvdXJuYWxdCiAgICAgIENvbXByZXNzPXllcwogICAgICBTeXN0ZW1NYXhVc2U9NTAwTQogICAgICBTeXN0ZW1NYXhGaWxlU2l6ZT0xME0KICAtIHBhdGg6ICcvZXRjL3N5c3RlbWQvcmVzb2x2ZWQuY29uZi5kLzEwLWZpeF9kbnMuY29uZicKICAgIGNvbnRlbnQ6IHwKICAgICAgW1Jlc29sdmVdCiAgICAgIEROUz04LjguOC44CiAgICAgIEZhbGxiYWNrRE5TPTguOC40LjQKICAtIHBhdGg6ICcvaG9tZS9jb3JlL2h1Yi5jb25mJwogICAgY29udGVudDogfAogICAgICB1cHN0cmVhbSB1cF9wYW5hbWF4X2FwaSB7CiAgICAgICAgc2VydmVyIFBNWF9BUEk6MzAwMDsKICAgICAgfQogICAgICB1cHN0cmVhbSB1cF9wYW5hbWF4X3VpIHsKICAgICAgICBzZXJ2ZXIgUE1YX1VJOjMwMDA7CiAgICAgIH0KCiAgICAgIHNlcnZlciB7CiAgICAgICAgcmV3cml0ZV9sb2cgb247CiAgICAgICAgbGlzdGVuICAgICAgIDYwMDEgc3NsOwogICAgICAgIHNlcnZlcl9uYW1lICBsb2NhbGhvc3Q7CiAgICAgICAgZXJyb3JfcGFnZSA0OTcgIGh0dHBzOi8vJGhvc3Q6JHNlcnZlcl9wb3J0JHJlcXVlc3RfdXJpOwogICAgICAgIHNzbCBvbjsKICAgICAgICBzc2xfY2VydGlmaWNhdGUgICAgICAvZXRjL25naW54L2NlcnQvc2VydmVyLmNydDsKICAgICAgICBzc2xfY2VydGlmaWNhdGVfa2V5ICAvZXRjL25naW54L2NlcnQvc2VydmVyLmtleTsKICAgICAgICBzc2xfc2Vzc2lvbl9jYWNoZSBzaGFyZWQ6U1NMOjFtOwogICAgICAgIHNzbF9zZXNzaW9uX3RpbWVvdXQgIDVtOwogICAgICAgIHNzbF9jaXBoZXJzICBISUdIOiFhTlVMTDohTUQ1OwogICAgICAgIHNzbF9wcmVmZXJfc2VydmVyX2NpcGhlcnMgICBvbjsKICAgICAgICBsb2NhdGlvbiAvIHsKICAgICAgICAgIHByb3h5X3Bhc3MgaHR0cDovL3VwX3BhbmFtYXhfYXBpOwogICAgICAgICAgcHJveHlfc2V0X2hlYWRlciBIb3N0ICRob3N0OyAjIG5naW54IHB1YmxpYyBpcAogICAgICAgICAgcHJveHlfc2V0X2hlYWRlciBYLUZvcndhcmRlZC1Ib3N0ICRodHRwX2hvc3Q7ICMgc2FtZSBhcyB0aGUgcmVxdWVzdCBIVFRQX0hPU1QKICAgICAgICAgIHByb3h5X3NldF9oZWFkZXIgWC1Gb3J3YXJkZWQtRm9yICRwcm94eV9hZGRfeF9mb3J3YXJkZWRfZm9yOyAjIGJyb3dzZXIgaXAKICAgICAgICAgIHByb3h5X3NldF9oZWFkZXIgWC1Gb3J3YXJkZWQtUHJvdG8gJHNjaGVtZTsKICAgICAgICAgIHByb3h5X3NldF9oZWFkZXIgWC1SZWFsLUlQICRyZW1vdGVfYWRkcjsKICAgICAgICAgICMgYWRkX2hlYWRlciAiQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luIiAiKiI7CiAgICAgICAgICAjIGFkZF9oZWFkZXIgIkFjY2Vzcy1Db250cm9sLUFsbG93LU1ldGhvZHMiICIqIjsKICAgICAgICB9CiAgICAgIH0KICAgICAgc2VydmVyIHsKICAgICAgICByZXdyaXRlX2xvZyBvbjsKICAgICAgICBsaXN0ZW4gICAgICAgNjAwMiBzc2w7CiAgICAgICAgc2VydmVyX25hbWUgIGxvY2FsaG9zdDsKICAgICAgICBlcnJvcl9wYWdlIDQ5NyAgaHR0cHM6Ly8kaG9zdDokc2VydmVyX3BvcnQkcmVxdWVzdF91cmk7CiAgICAgICAgc3NsIG9uOwogICAgICAgIHNzbF9jZXJ0aWZpY2F0ZSAgICAgIC9ldGMvbmdpbngvY2VydC9zZXJ2ZXIuY3J0OwogICAgICAgIHNzbF9jZXJ0aWZpY2F0ZV9rZXkgIC9ldGMvbmdpbngvY2VydC9zZXJ2ZXIua2V5OwogICAgICAgIHNzbF9zZXNzaW9uX2NhY2hlIHNoYXJlZDpTU0w6MW07CiAgICAgICAgc3NsX3Nlc3Npb25fdGltZW91dCAgNW07CiAgICAgICAgc3NsX2NpcGhlcnMgIEhJR0g6IWFOVUxMOiFNRDU7CiAgICAgICAgc3NsX3ByZWZlcl9zZXJ2ZXJfY2lwaGVycyAgIG9uOwogICAgICAgIGxvY2F0aW9uIC8gewogICAgICAgICAgcHJveHlfcGFzcyBodHRwOi8vdXBfcGFuYW1heF91aTsKICAgICAgICAgIHByb3h5X3NldF9oZWFkZXIgSG9zdCAkaG9zdDsgIyBuZ2lueCBwdWJsaWMgaXAKICAgICAgICAgIHByb3h5X3NldF9oZWFkZXIgWC1Gb3J3YXJkZWQtSG9zdCAkaHR0cF9ob3N0OyAjIHNhbWUgYXMgdGhlIHJlcXVlc3QgSFRUUF9IT1NUCiAgICAgICAgICBwcm94eV9zZXRfaGVhZGVyIFgtRm9yd2FyZGVkLUZvciAkcHJveHlfYWRkX3hfZm9yd2FyZGVkX2ZvcjsgIyBicm93c2VyIGlwCiAgICAgICAgICBwcm94eV9zZXRfaGVhZGVyIFgtRm9yd2FyZGVkLVByb3RvICRzY2hlbWU7CiAgICAgICAgICBwcm94eV9zZXRfaGVhZGVyIFgtUmVhbC1JUCAkcmVtb3RlX2FkZHI7CiAgICAgICAgICAjIGFkZF9oZWFkZXIgIkFjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbiIgIioiOwogICAgICAgICAgIyBhZGRfaGVhZGVyICJBY2Nlc3MtQ29udHJvbC1BbGxvdy1NZXRob2RzIiAiKiI7CiAgICAgICAgfQogICAgICB9Cgpjb3Jlb3M6CiAgdXBkYXRlOgogICAgcmVib290LXN0cmF0ZWd5OiAnb2ZmJwogIHVuaXRzOgogICAgLSBuYW1lOiAnc3lzdGVtZC1qb3VybmFsZC5zZXJ2aWNlJwogICAgICBjb21tYW5kOiAncmVsb2FkLW9yLXJlc3RhcnQnCiAgICAtIG5hbWU6ICdkb2NrZXIuc2VydmljZScKICAgICAgZHJvcC1pbnM6CiAgICAgICAgLSBuYW1lOiAnNTAtaW5zZWN1cmUtcmVnaXN0cnkuY29uZicKICAgICAgICAgIGNvbnRlbnQ6IHwKICAgICAgICAgICAgW1NlcnZpY2VdCiAgICAgICAgICAgIEVudmlyb25tZW50PSdET0NLRVJfT1BUUz0tLWxvZy1sZXZlbD0iZGVidWciIC0taW5zZWN1cmUtcmVnaXN0cnk9IjAuMC4wLjAvMCInCiAgICAtIG5hbWU6ICdzeXN0ZW1kLWpvdXJuYWwtZ2F0ZXdheWQuc2VydmljZScKICAgICAgY29tbWFuZDogJ3N0YXJ0JwogICAgLSBuYW1lOiAnZmxlZXQuc2VydmljZScKICAgICAgY29tbWFuZDogJ3N0YXJ0JwogICAgLSBuYW1lOiAncGFuYW1heC1tZXRyaWNzLnNlcnZpY2UnCiAgICAgIGNvbW1hbmQ6ICdzdGFydCcKICAgICAgY29udGVudDogfAogICAgICAgIFtVbml0XQogICAgICAgIERlc2NyaXB0aW9uPVBhbmFtYXggTWV0cmljcwogICAgICAgIEFmdGVyPWRvY2tlci5zZXJ2aWNlCiAgICAgICAgUmVxdWlyZXM9ZG9ja2VyLnNlcnZpY2UKICAgICAgICBbU2VydmljZV0KICAgICAgICBFeGVjU3RhcnRQcmU9LS91c3IvYmluL2RvY2tlciBraWxsIFBNWF9DQURWSVNPUgogICAgICAgIEV4ZWNTdGFydFByZT0tL3Vzci9iaW4vZG9ja2VyIHJtIC1mIFBNWF9DQURWSVNPUgogICAgICAgIEV4ZWNTdGFydD0vdXNyL2Jpbi9kb2NrZXIgcnVuIC0tbmFtZT1QTVhfQ0FEVklTT1IgLS1ybT10cnVlIC0tdm9sdW1lPS92YXIvcnVuOi92YXIvcnVuOnJ3IC0tdm9sdW1lPS9zeXM6L3N5czpybyAtLXZvbHVtZT0vdmFyL2xpYi9kb2NrZXIvOi92YXIvbGliL2RvY2tlcjpybyAtLXB1Ymxpc2g9MzAwMjo4MDgwIGdvb2dsZS9jYWR2aXNvcjpsYXRlc3QgLWxvZ19kaXIgLyAtLWdsb2JhbF9ob3VzZWtlZXBpbmdfaW50ZXJ2YWw9MzBzIC0taG91c2VrZWVwaW5nX2ludGVydmFsPTE3cwogICAgICAgIEV4ZWNTdG9wPS91c3IvYmluL2RvY2tlciBzdG9wIFBNWF9DQURWSVNPUgogICAgICAgIFJlc3RhcnQ9YWx3YXlzCiAgICAgICAgW0luc3RhbGxdCiAgICAgICAgV2FudGVkQnk9bXVsdGktdXNlci50YXJnZXQKICAgIC0gbmFtZTogJ3BhbmFtYXgtYXBpLnNlcnZpY2UnCiAgICAgIGNvbW1hbmQ6ICdzdGFydCcKICAgICAgY29udGVudDogfAogICAgICAgIFtVbml0XQogICAgICAgIERlc2NyaXB0aW9uPVBhbmFtYXggQVBJCiAgICAgICAgQWZ0ZXI9ZG9ja2VyLnNlcnZpY2UKICAgICAgICBSZXF1aXJlcz1kb2NrZXIuc2VydmljZQogICAgICAgIFtTZXJ2aWNlXQogICAgICAgIEV4ZWNTdGFydFByZT0tL3Vzci9iaW4vZG9ja2VyIGtpbGwgUE1YX0FQSQogICAgICAgIEV4ZWNTdGFydFByZT0tL3Vzci9iaW4vZG9ja2VyIHJtIFBNWF9BUEkKICAgICAgICBFeGVjU3RhcnQ9L3Vzci9iaW4vZG9ja2VyIHJ1biAtLW5hbWU9UE1YX0FQSSAtLXJtPXRydWUgLXYgL3Zhci9wYW5hbWF4LWRhdGE6L3Vzci9zcmMvYXBwL2RiL21udCAtdiAvdmFyL3J1bi9kb2NrZXIuc29jazovcnVuL2RvY2tlci5zb2NrOnJ3ICAtZSBKT1VSTkFMX0VORFBPSU5UPWh0dHA6Ly8xNzIuMTcuNDIuMToxOTUzMSAtdiAvdmFyL3J1bi9mbGVldC5zb2NrOi92YXIvcnVuL2ZsZWV0LnNvY2s6cncgLXQgLXAgMzAwMTozMDAwIGZpYzIvcGFuYW1heC1hcGk6bGF0ZXN0CiAgICAgICAgRXhlY1N0b3A9L3Vzci9iaW4vZG9ja2VyIHN0b3AgUE1YX0FQSQogICAgICAgIFJlc3RhcnQ9YWx3YXlzCiAgICAgICAgW0luc3RhbGxdCiAgICAgICAgV2FudGVkQnk9bXVsdGktdXNlci50YXJnZXQKICAgIC0gbmFtZTogJ3BhbmFtYXgtdWkuc2VydmljZScKICAgICAgY29tbWFuZDogJ3N0YXJ0JwogICAgICBjb250ZW50OiB8CiAgICAgICAgW1VuaXRdCiAgICAgICAgRGVzY3JpcHRpb249UGFuYW1heCBVSQogICAgICAgIEFmdGVyPXBhbmFtYXgtYXBpLnNlcnZpY2UgcGFuYW1heC1tZXRyaWNzLnNlcnZpY2UKICAgICAgICBbU2VydmljZV0KICAgICAgICBFeGVjU3RhcnRQcmU9LS91c3IvYmluL2RvY2tlciBraWxsIFBNWF9VSQogICAgICAgIEV4ZWNTdGFydFByZT0tL3Vzci9iaW4vZG9ja2VyIHJtIC1mIFBNWF9VSQogICAgICAgIEV4ZWNTdGFydD0vdXNyL2Jpbi9kb2NrZXIgcnVuIC0tbmFtZT1QTVhfVUkgLS1ybT10cnVlIC12IC92YXIvcnVuL2RvY2tlci5zb2NrOi9ydW4vZG9ja2VyLnNvY2s6cncgLS1saW5rPVBNWF9BUEk6UE1YX0FQSSAtLWxpbms9UE1YX0NBRFZJU09SOlBNWF9DQURWSVNPUiAtZSAzMDAwIC1wIDMwMDA6MzAwMCAgZmljMi9wYW5hbWF4LXVpOmxhdGVzdAogICAgICAgIEV4ZWNTdG9wPS91c3IvYmluL2RvY2tlciBzdG9wIFBNWF9VSQogICAgICAgIFJlc3RhcnQ9YWx3YXlzCiAgICAgICAgW0luc3RhbGxdCiAgICAgICAgV2FudGVkQnk9bXVsdGktdXNlci50YXJnZXQKICAgIC0gbmFtZTogJ3BhbmFtYXgtYXBpLW5naW54LnNlcnZpY2UnCiAgICAgIGNvbW1hbmQ6ICdzdGFydCcKICAgICAgY29udGVudDogfAogICAgICAgIFtVbml0XQogICAgICAgIERlc2NyaXB0aW9uPVBhbmFtYXggTmdpbnggZnJvbnRlbmQKICAgICAgICBBZnRlcj1wYW5hbWF4LWFwaS5zZXJ2aWNlCiAgICAgICAgW1NlcnZpY2VdCiAgICAgICAgRXhlY1N0YXJ0UHJlPS0vdXNyL2Jpbi9kb2NrZXIga2lsbCBQTVhfQVBJX05HSU5YCiAgICAgICAgRXhlY1N0YXJ0UHJlPS0vdXNyL2Jpbi9kb2NrZXIgcm0gLWYgUE1YX0FQSV9OR0lOWAogICAgICAgIEV4ZWNTdGFydD0vdXNyL2Jpbi9kb2NrZXIgcnVuIC0tbmFtZT1QTVhfQVBJX05HSU5YIC0tcm09dHJ1ZSAtdCAtdiAvZGV2L3VyYW5kb206L2Rldi9yYW5kb20gLXYgL2hvbWUvY29yZS9odWIuY29uZjovZXRjL25naW54L3NpdGVzLWVuYWJsZWQvaHViLmNvbmYgLS1saW5rPVBNWF9BUEk6UE1YX0FQSSAtLWxpbms9UE1YX1VJOlBNWF9VSSAtZSA2MDAxIC1wIDYwMDE6NjAwMSAtZSA2MDAyIC1wIDYwMDI6NjAwMiBjZ2VvZmZyb3kvbmdpbngtYXV0b19jZXJ0OmxhdGVzdAogICAgICAgIEV4ZWNTdG9wPS91c3IvYmluL2RvY2tlciBzdG9wIFBNWF9BUElfTkdJTlgKICAgICAgICBSZXN0YXJ0PWFsd2F5cwogICAgICAgIFtJbnN0YWxsXQogICAgICAgIFdhbnRlZEJ5PW11bHRpLXVzZXIudGFyZ2V0"
      }
    },

    "PanamaxSecurityGroup" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "Tags" : [ {"Key" : "Name", "Value" : "FIC2Lab Panamax Security Group"} ],
        "GroupDescription" : "Enable SSH access via port 22",
        "SecurityGroupIngress" : [ 
        { "IpProtocol" : "tcp",
          "FromPort" : "22",
          "ToPort" : "22",
          "CidrIp" : "0.0.0.0/0" },
        { "IpProtocol" : "tcp",
          "FromPort" : "3000",
          "ToPort" : "3000",
          "CidrIp" : "0.0.0.0/0" },
        { "IpProtocol" : "tcp",
          "FromPort" : "3001",
          "ToPort" : "3001",
          "CidrIp" : "0.0.0.0/0" },
        { "IpProtocol" : "tcp",
          "FromPort" : "3002",
          "ToPort" : "3002",
          "CidrIp" : "0.0.0.0/0" },
        { "IpProtocol" : "tcp",
          "FromPort" : "49000",
          "ToPort" : "52000",
          "CidrIp" : "0.0.0.0/0" }
        ]
      }
    }
  },
  "Outputs": {
    "PanamaxURL": {
      "Value": {
        "Fn::Join": [
          "",
          [
            "http://",
            {
              "Fn::GetAtt": [
                "PanamaxEc2Instance",
                "PublicDnsName"
              ]
            },
            ":3000"
          ]
        ]
      },
      "Description" : "Panamax management console (you may need to wait a couple of minutes the first time)"
    }
  }
}
